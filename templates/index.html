{% extends "base.html" %}

{% block content %}
<div class="header">
    {% include 'components/navbar.html' %}
    <div class="filter-container">
        <input type="text"
               id="filter-input"
               class="filter-input"
               placeholder="Filter by tag...">
        <div class="filter-toggles">
            <label class="toggle-switch">
                <input type="checkbox" id="or-filter-toggle">
                <span class="toggle-slider"></span>
                <span class="toggle-label">OR</span>
            </label>
            <label class="toggle-switch">
                <input type="checkbox" id="not-filter-toggle">
                <span class="toggle-slider"></span>
                <span class="toggle-label">NOT</span>
            </label>
        </div>
        <div id="tag-suggestions" class="tag-suggestions"></div>
        <div id="selected-filters" class="selected-filters"></div>
        <div id="batch-delete-container">

            <div class="batch-actions">
                <button id="select-visible-button" class="select-visible-button" onclick="selectVisibleVideos()">
                    Select Visible
                </button>
                <div class="batch-tag-input-container">
                    <input type="text"
                           id="batch-tag-input"
                           class="batch-tag-input"
                           placeholder="Add tag to selected..."
                           style="display: none;">
                    <div id="batch-tag-suggestions" class="tag-suggestions"></div>
                </div>
                <button id="batch-delete-button" class="batch-delete-button" onclick="confirmBatchDelete()">
                    Delete Selected (<span id="selected-count">0</span>)
                </button>
                <button id="cancel-batch-delete" class="cancel-batch-button" onclick="cancelBatchSelection()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<div id="videos-grid" class="videos-grid">
    <!-- Videos will be inserted here -->
</div>

<div id="loading-spinner">
    <div class="spinner"></div>
</div>

<script>
function playVideo(thumbnailElement, videoPath) {
    // Create video element
    const video = document.createElement('video');
    video.controls = true;
    video.style.width = '100%';  // Match the thumbnail width
    video.style.height = 'auto';

    // Create source element
    const source = document.createElement('source');
    source.src = `/video/${videoPath}`;
    source.type = 'video/mp4';

    // Add source to video
    video.appendChild(source);

    // Replace thumbnail with video
    thumbnailElement.parentNode.replaceChild(video, thumbnailElement);

    // Play the video
    video.play();
}
</script>

<!-- Add the video modal HTML if not already present -->
<div id="videoModal" class="modal" style="display: none;">
    <video id="videoPlayer" controls>
        <source id="videoSource" src="" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<style>
/* Reset container and all parent elements */
html, body, .container {
    margin: 0;
    padding: 0;
    width: 100%;
    max-width: 100%;
}

/* Ensure the container takes full width */
.container {
    width: 100vw;
    max-width: 100vw;
    padding: 0;
    margin: 0;
    box-sizing: border-box;
}

/* Keep grid at full width */
.videos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    padding: 20px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

/* Ensure content area is full width */
.content {
    width: 100%;
    max-width: 100%;
    padding: 0;
    margin: 0;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.modal video {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 90vh;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.author {
    font-weight: bold;
    margin-bottom: 0.5em;
    color: #333;
}

.description {
    margin-top: 0;
    color: #666;
}

.video-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.video-thumbnail-container {
    position: relative;
    width: 100%;
    padding-top: 177.5%; /* TikTok aspect ratio (9:16) */
    overflow: hidden;
}

.video-thumbnail-container video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: black;
}

.video-thumbnail {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-info {
    padding: 15px;
}

/* Ensure videos maintain aspect ratio when replacing thumbnails */
video {
    aspect-ratio: 9/16;
    object-fit: cover;
    width: 100%;
    background: black;
}

/* Ensure parent containers don't restrict width */
body {
    margin: 0;
    padding: 0;
    width: 100%;
}

/* Header layout */
.header {
    background-color: #fff;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

.filter-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.filter-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
}

.filter-toggles {
    display: flex;
    gap: 20px;
    align-items: center;
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.toggle-label {
    font-size: 14px;
    font-weight: 500;
}

.selected-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 0;
}

.filter-tag {
    background: #f0f0f0;
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.username-tag {
    background: #e3f2fd;
}

.remove-tag {
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.2s;
}

.remove-tag:hover {
    opacity: 1;
}

/* Tag suggestions */
.tag-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
}

.tag-suggestion {
    padding: 8px 12px;
    cursor: pointer;
}

.tag-suggestion:hover {
    background: #f5f5f5;
}

/* Batch actions */
.batch-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.select-visible-button,
.batch-delete-button,
.cancel-batch-button {
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

.select-visible-button {
    background: #f0f0f0;
}

.batch-delete-button {
    background: #ff4444;
    color: white;
}

.cancel-batch-button {
    background: #666;
    color: white;
}

/* Batch tag input */
.batch-tag-input-container {
    position: relative;
    flex-grow: 1;
}

.batch-tag-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Initialize empty arrays and sets
window.filteredVideos = [];
window.selectedFilters = new Set();

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});
</script>
<script src="{{ url_for('static', filename='js/video-browser.js') }}"></script>
<script>
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (!window.initialized) {
        console.log('DOM loaded, initializing app...');
        window.initialized = true;
        initializeApp();
    }
});
</script>
<script>
console.log('Filters:', window.allFilters);
console.log('Videos:', window.allVideos);
</script>
{% endblock %}
